#!/usr/bin/php
<?php
include_once 'miners-settlement-init.php';

include_once 'common/debug.class.php';
include_once 'local/simulator.class.php';
include_once 'local/battle.class.php';
include_once 'local/entity.class.php';
include_once 'local/item.class.php';
include_once 'local/rune.class.php';

$debug     = new Debug(9,DEBUG_CLI);
$item      = new Item($debug);
$item1     = new Item($debug);
$item2     = new Item($debug);
$attacker  = new Entity($debug);
$defender  = new Entity($debug);
$battle    = new Battle($debug);
$constants = new Constants($debug);
$simulator = new Simulator($debug);

$opts = getopt(null,array('verbose','short','debug:','type:','attacker:','aname:','defender:','iterations:','godroll','enhance:'));

$debugLevel    = $opts['debug'] ?: 0;
$verbose       = (isset($opts['verbose'])) ? true : false;
$shortResults  = (isset($opts['short'])) ? true : false;
$simulateType  = $opts['type'] ?: 'pve';
$attackerBuild = $opts['attacker'] ?: null;
$attackerName  = $opts['aname'] ?: null;
$defenderBuild = $opts['defender'] ?: null;
$uIterations   = $opts['iterations'] ?: 100;
$uGodroll      = (isset($opts['godroll'])) ? true : false;
$uEnhance      = $opts['enhance'] ?: null;

$simulateType = strtolower($simulateType);


if (preg_match('/^(pve|pvp)$/i',$simulateType) && $attackerBuild && $defenderBuild) { 
   $setup = array(
      'type'       => $simulateType,
      'attacker'   => array('id' => $attackerBuild),
      'defender'   => array('id' => $defenderBuild),
      'iterations' => $uIterations,
      'godroll'    => $uGodroll,
      'enhance'    => $uEnhance,
      'aname'      => $attackerName,
   );
}
else if ($simulateType == 'test-builds' && $attackerBuild && $defenderBuild) {
   $buildList = array();
   foreach (explode(',',$attackerBuild) as $build) { $buildList[$build]['id'] = $build; }

   $setup = array(
      'type'       => 'pve',
      'attacker'   => array('tests' => $buildList),
      'defender'   => array('id' => $defenderBuild),
      'iterations' => $uIterations,
   );
}
else { 
   // Sample two weapon test setup
   $setup = array(
      'type' => 'pve',
      'iterations' => $uIterations,
      'attacker' => array(
         'id' => 'lunaivy-sotg-dragon',
         'tests' => array(
            'weaponA' => array(
               'gear'  => array(
                  'spear-of-the-gods' => array(
                     'values'  => array('health' => 748, 'attack' => 333, 'defense' => 50, 'speed' => 0.86, 'earth.damage' => 175, 'lightning.resist' => 124),
                     'options' => array('level'  => 7),
                  ),
               ),
            ),
            'weaponB' => array(
               'gear'  => array(
                  'spear-of-the-gods' => array(
                     'values' => array('health' => 473, 'attack' => 247, 'defense' => 99, 'speed' => 0.92, 'earth.damage' => 279, 'lightning.resist' => 160),
                     'options' => array('level'  => 7),
                  ),
               ),
            ),
         ),
      ),
      'defender' => array(
         'id'   => 'wind-dragon-83',
         'gear' => array(),
      ),
   );
}

$debug->level($debugLevel);


$tests = array();

$baseConfig = array(
   'attacker'   => array('id' => $setup['attacker']['id'], 'gear' => $setup['attacker']['gear']),
   'defender'   => array('id' => $setup['defender']['id'], 'gear' => $setup['defender']['gear']),
   'type'       => $setup['type'],
   'iterations' => $setup['iterations'],
   'godroll'    => $setup['godroll'],
   'enhance'    => $setup['enhance'],
   'aname'      => $setup['aname'],
);

$testList = ($setup['attacker']['tests']) ? array_keys($setup['attacker']['tests']) : array($setup['type']);

foreach ($testList as $testName) {
   $testConfig = $baseConfig;
   $overrides  = $setup['attacker']['tests'][$testName];
 
   if ($overrides['id'])   { $testConfig['attacker']['id'] = $overrides['id']; }
   if ($overrides['gear']) { $testConfig['attacker']['gear'] = $overrides['gear']; }

   $testConfig['label'] = $testName;

   $tests[$testName] = $testConfig;
}

foreach ($tests as $testName => $testInfo) {
   //print "\nStarting test $testName ".json_encode($testInfo)."\n\n";

   $results = $simulator->start($testInfo);

   if ($verbose) { print json_encode($results,JSON_UNESCAPED_SLASHES|JSON_PRETTY_PRINT)."\n"; }

   print $simulator->formatResults($results,array('short' => $shortResults, 'name' => $testName))."\n\n\n";
}

?>
